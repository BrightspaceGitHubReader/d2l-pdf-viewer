<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-page-load-progress/d2l-page-load-progress.html">
<link rel="import" href="d2l-pdf-viewer-toolbar.html">

<!-- @note: aware that external stylesheets are very deprecated -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.0.943/pdf_viewer.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.0.943/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.0.943/pdf_viewer.js"></script>

<dom-module id="d2l-pdf-viewer">
	<template strip-whitespace>
		<style>
			:host {
				display: inline-block;
				position: relative;
				width: 100%;
				height: 100%;
				background-color: grey;
			}

			#viewerContainer {
				position: relative;
				overflow: auto;
				width: 100%;
				height: calc(100% - 49px);
			}

			d2l-pdf-viewer-toolbar {
				position: relative;
				left: 0;
				right: 0;
				cursor: default;
			}

			d2l-page-load-progress[hidden] {
				display: none !important;
			}
		</style>
		<d2l-page-load-progress id="loadingBar" autohide></d2l-page-load-progress>
		<div id="viewerContainer">
			<div id="viewer" class="pdfViewer"></div>
		</div>
		<d2l-pdf-viewer-toolbar
			id="toolbar"
			page-label="[[_pageLabel]]"
			page-number="[[_pageNumber]]"
			pages-count="[[_pagesCount]]"
			has-page-labels="[[_hasPageLabels]]"
			page-scale="[[_pageScale]]"
			min-page-scale="[[_minPageScale]]"
			max-page-scale="[[_maxPageScale]]">
		</d2l-pdf-viewer-toolbar>
	</template>
	<script>
		/* global pdfjsViewer, pdfjsLib */

		/**
		 * `<d2l-pdf-viewer>`
		 *
		 * @customElement
		 * @polymer
		 * @demo demo/index.html
		 */
		Polymer({
			is: 'd2l-pdf-viewer',
			properties: {
				src: {
					type: String,
					observer: '_srcChanged'
				},
				_pageLabel: {
					type: String,
					value: null
				},
				_pageNumber: {
					type: Number
				},
				_pagesCount: {
					type: Number
				},
				_hasPageLabels: {
					type: Boolean,
					value: false
				},
				_pageScale: {
					type: Number
				},
				_minPageScale: {
					type: Number,
					value: 0.1
				},
				_maxPageScale: {
					type: Number,
					value: 2
				}
			},
			ready: function() {
				pdfjsLib.GlobalWorkerOptions.workerSrc =
					'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.0.943/pdf.worker.min.js';

				// (Optionally) enable hyperlinks within PDF files.
				var pdfLinkService = new pdfjsViewer.PDFLinkService();

				this._pdfViewer = new pdfjsViewer.PDFViewer({
					container: this.$.viewerContainer,
					linkService: pdfLinkService
				});

				pdfLinkService.setViewer(this._pdfViewer);

				// Add event listeners before loading document
				this._addEventListeners();

				pdfjsLib.getDocument({
					url: this.src
				}).then(pdfDocument => {
					this._pdfViewer.setDocument(pdfDocument);
					this._pagesCount = pdfDocument.numPages;
					this._pageNumber = this._pdfViewer.currentPageNumber;

					pdfLinkService.setDocument(pdfDocument, null);
				}).catch(() => {
					this.$.loadingBar.finish();
					this.dispatchEvent(new CustomEvent('d2l-pdf-viewer-load-failed', {
						bubbles: true,
						composed: true
					}));
				});
			},
			detached: function() {
				window.removeEventListener('resize', this._resize);
			},
			_addEventListeners: function() {
				this._resize = this._resize.bind(this);

				window.addEventListener('resize', this._resize);

				this.$.viewerContainer.addEventListener('pagesinit', this._onPagesInitEvent.bind(this));
				this.$.viewerContainer.addEventListener('pagechange', this._onPageChangeEvent.bind(this));

				this.$.toolbar.addEventListener('d2l-pdf-viewer-toolbar-previous', this._onPrevPageEvent.bind(this));
				this.$.toolbar.addEventListener('d2l-pdf-viewer-toolbar-next', this._onNextPageEvent.bind(this));
				this.$.toolbar.addEventListener('d2l-pdf-viewer-toolbar-zoom-in', this._onZoomInEvent.bind(this));
				this.$.toolbar.addEventListener('d2l-pdf-viewer-toolbar-zoom-out', this._onZoomOutEvent.bind(this));
				this.$.toolbar.addEventListener('d2l-pdf-viewer-toolbar-page-change', this._onPageNumberChangedEvent.bind(this));
			},
			_resize: function() {
				if (!this._resizeThrottleHandle) {
					this._resizeThrottleHandle = setTimeout(() => {
						var currentScaleValue = this._pdfViewer.currentScaleValue;

						if (currentScaleValue === 'auto' ||
							currentScaleValue === 'page-fit' ||
							currentScaleValue === 'page-width') {
							// Note: the scale is constant for 'page-actual'.
							this._pdfViewer.currentScaleValue = currentScaleValue;
						}

						this._pageScale = this._pdfViewer.currentScale;
						this._pdfViewer.update();
						this._resizeThrottleHandle = null;
					}, 100);
				}
			},
			_srcChanged: function() {
				this.$.loadingBar.start();
			},
			_onPagesInitEvent: function() {
				this._pdfViewer.currentScaleValue = 'page-width';
				this._pageScale = this._pdfViewer.currentScale;
				this.$.loadingBar.finish();
			},
			_onPageChangeEvent: function(evt) {
				this._pageNumber = evt.pageNumber;
			},
			_onNextPageEvent: function() {
				this._setPageNumber(this._pdfViewer.currentPageNumber + 1);
			},
			_onPrevPageEvent: function() {
				this._setPageNumber(this._pdfViewer.currentPageNumber - 1);
			},
			_onZoomInEvent: function() {
				this._addDeltaZoom(0.1);
			},
			_onZoomOutEvent: function() {
				this._addDeltaZoom(-0.1);
			},
			_onPageNumberChangedEvent: function(evt) {
				var newPage = parseInt(evt.detail.page);

				this._setPageNumber(newPage);
			},
			_addDeltaZoom: function(delta) {
				var newZoom = this._pdfViewer.currentScale + delta;

				this._setScale(newZoom);
			},
			_setPageNumber: function(pageNumber) {
				if (pageNumber < 1 || pageNumber > this._pagesCount) {
					return;
				}

				this._pdfViewer.currentPageNumber = pageNumber;
				this._pageNumber = pageNumber;
			},
			_setScale: function(newScale) {
				this._pdfViewer.currentScaleValue = Math.max(
					this._minPageScale,
					Math.min(this._maxPageScale, newScale)
				);

				this._pageScale = this._pdfViewer.currentScale;
			}
		});
	</script>
</dom-module>
